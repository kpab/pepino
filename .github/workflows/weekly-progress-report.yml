name: Weekly Progress Report

on:
  schedule:
    - cron: '0 9 * * MON'  # ÊØéÈÄ±ÊúàÊõúÊó• 9:00 JST
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  generate-progress-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate progress report
        id: progress
        run: |
          # GitHub API„Çí‰ΩøÁî®„Åó„Å¶ÈÄ≤Êçó„Éá„Éº„Çø„ÇíÂèñÂæó
          echo "## üìä ÈÄ±Ê¨°ÈÄ≤Êçó„É¨„Éù„Éº„Éà $(date '+%YÂπ¥%mÊúà%dÊó•')" > progress-report.md
          echo "" >> progress-report.md
          
          # ‰ªäÈÄ±„ÅÆIssue/PRÁµ±Ë®à
          echo "### üìà ‰ªäÈÄ±„ÅÆÂÆüÁ∏æ" >> progress-report.md
          echo "- Êñ∞Ë¶èIssue: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.created_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | length')" >> progress-report.md
          echo "- ÂÆå‰∫ÜIssue: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.closed_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")) and .state == "closed")] | length')" >> progress-report.md
          echo "- „Éû„Éº„Ç∏„Åï„Çå„ÅüPR: $(gh api repos/${{ github.repository }}/pulls --jq '[.[] | select(.merged_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")) and .merged == true)] | length')" >> progress-report.md
          echo "" >> progress-report.md
          
          # „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó
          echo "### üéØ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÄ≤Êçó" >> progress-report.md
          echo "- ÈÄ≤Ë°å‰∏≠„Çø„Çπ„ÇØ: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.state == "open")] | length')" >> progress-report.md
          echo "- ÂÆå‰∫Ü„Çø„Çπ„ÇØ: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.state == "closed")] | length')" >> progress-report.md
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue with Progress Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('progress-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä ÈÄ±Ê¨°ÈÄ≤Êçó„É¨„Éù„Éº„Éà ${new Date().toLocaleDateString('ja-JP')}`,
              body: report,
              labels: ['progress-report', 'weekly']
            });