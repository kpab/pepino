name: Weekly Progress Report & Gantt Update

on:
  schedule:
    - cron: '0 9 * * MON'  # æ¯é€±æœˆæ›œæ—¥ 9:00 JST
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-gantt-and-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm init -y
          npm install @octokit/rest

      - name: Update Gantt Chart
        id: gantt-update
        run: |
          cd .github/scripts
          node update-gantt.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate detailed progress report
        id: progress
        run: |
          # è©³ç´°ãªé€²æ—ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          echo "## ğŸ“Š é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ $(date '+%Yå¹´%mæœˆ%dæ—¥')" > progress-report.md
          echo "" >> progress-report.md
          
          # ä»Šé€±ã®Issue/PRçµ±è¨ˆ
          echo "### ğŸ“ˆ ä»Šé€±ã®å®Ÿç¸¾" >> progress-report.md
          echo "- æ–°è¦Issue: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.created_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | length')" >> progress-report.md
          echo "- å®Œäº†Issue: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.closed_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")) and .state == "closed")] | length')" >> progress-report.md
          echo "- ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPR: $(gh api repos/${{ github.repository }}/pulls --jq '[.[] | select(.merged_at > (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ")) and .merged == true)] | length')" >> progress-report.md
          echo "" >> progress-report.md
          
          # å…¨ä½“é€²æ—
          echo "### ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“é€²æ—" >> progress-report.md
          echo "- é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.state == "open")] | length')" >> progress-report.md
          echo "- å®Œäº†ã‚¿ã‚¹ã‚¯: $(gh api repos/${{ github.repository }}/issues --jq '[.[] | select(.state == "closed")] | length')" >> progress-report.md
          echo "" >> progress-report.md
          
          # ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ›´æ–°é€šçŸ¥
          echo "### ğŸ”„ ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ›´æ–°" >> progress-report.md
          echo "- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãŒæœ€æ–°ã®é€²æ—ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã—ãŸ" >> progress-report.md
          echo "- è©³ç´°: [ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ](https://kpab.github.io/pepino/docs/project-management/gantt-chart)" >> progress-report.md
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit updated gantt chart
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/docs/project-management/04-gantt-chart.md
          if git diff --staged --quiet; then
            echo "ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "ğŸ“Š ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè‡ªå‹•æ›´æ–° - $(date '+%Y/%m/%d')"
            git push
          fi

      - name: Create Issue with Progress Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('progress-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š é€±æ¬¡é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ ${new Date().toLocaleDateString('ja-JP')}`,
              body: report,
              labels: ['progress-report', 'weekly']
            });