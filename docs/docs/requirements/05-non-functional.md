# ⚡ 非機能要件

## 🎯 概要

Pepinoアプリケーションの性能、信頼性、セキュリティ、運用性に関する要件を定義します。

---

## 🚀 パフォーマンス要件

### 応答時間要件

| 機能 | 目標時間 | 最大許容時間 | 測定条件 |
|------|----------|--------------|----------|
| 初回画面表示 | 2秒 | 5秒 | 位置情報取得含む、3G回線 |
| イベント一覧取得 | 500ms | 1秒 | 100件以内、Wi-Fi環境 |
| 近傍検索実行 | 300ms | 800ms | 5km圏内、PostGIS使用 |
| 地図表示 | 1秒 | 3秒 | Google Maps初回読み込み |
| イベント詳細表示 | 200ms | 500ms | キャッシュ済みデータ |
| 外部API連携 | 2秒 | 5秒 | connpass API応答時間 |

### スループット要件

| 指標 | MVP目標 | 成長期目標 | 備考 |
|------|---------|------------|------|
| 同時接続数 | 100 | 1,000 | ピーク時間帯 |
| API リクエスト/秒 | 50 | 500 | 検索・詳細取得合計 |
| 位置情報更新/分 | 200 | 2,000 | GPS更新頻度 |
| イベント取得/時 | 1,000 | 10,000 | 外部API経由含む |

### リソース使用量

| リソース | 制限値 | 監視しきい値 | 対応策 |
|----------|--------|--------------|--------|
| CPU使用率 | 80% | 70% | スケールアウト |
| メモリ使用量 | 512MB | 400MB | ガベージコレクション最適化 |
| データベース接続数 | 100 | 80 | コネクションプール調整 |
| ストレージ容量 | 1GB | 800MB | 古いデータ自動削除 |

---

## 🔒 セキュリティ要件

### データ保護

#### 位置情報保護
- **暗号化**: 保存時・転送時ともにAES-256暗号化
- **匿名化**: 100m単位でのジオハッシュ化
- **保持期間**: 7日間で自動削除
- **アクセス制御**: セッションIDベースの制限

#### 個人情報保護
- **収集最小化**: 必要最小限のデータのみ収集
- **同意ベース**: 明示的な同意なしに個人情報収集なし
- **削除権**: ユーザーによるデータ削除要求への対応
- **匿名化**: 統計処理時の個人特定情報除去

### 通信セキュリティ

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| HTTPS通信 | 全通信でHTTPS必須 | Let's Encrypt SSL証明書 |
| HSTS | Strict-Transport-Security | 最大年月設定 |
| CSP | Content Security Policy | インライン実行禁止 |
| CORS | Cross-Origin制限 | 許可ドメインのみ |

### 認証・認可（将来実装）

| レベル | 権限 | 実装方式 |
|--------|------|----------|
| ゲスト | 閲覧・外部サイト参加 | セッションベース |
| ユーザー | イベント作成・管理 | JWT + リフレッシュトークン |
| 主催者 | 複数イベント・分析 | ロールベースアクセス制御 |
| 管理者 | システム全体管理 | 多要素認証必須 |

---

## 📈 可用性・信頼性要件

### 稼働率目標

| フェーズ | 目標稼働率 | 月間ダウンタイム | 年間ダウンタイム |
|----------|------------|------------------|------------------|
| MVP | 99.0% | 7時間12分 | 3.65日 |
| 成長期 | 99.5% | 3時間36分 | 1.83日 |
| 成熟期 | 99.9% | 43分 | 8.76時間 |

### 障害対応

#### 障害レベル定義
| レベル | 影響範囲 | 対応時間 | 通知方法 |
|--------|----------|----------|----------|
| Critical | 全サービス停止 | 15分以内 | 即座にアラート |
| High | 主要機能不具合 | 1時間以内 | 30分以内に通知 |
| Medium | 一部機能不具合 | 4時間以内 | 1時間以内に通知 |
| Low | 軽微な不具合 | 24時間以内 | 定期レポート |

#### 復旧手順
```
1. 障害検知（監視システム・ユーザー報告）
2. 影響範囲調査（30分以内）
3. 応急対応実施（1時間以内）
4. 根本原因調査（3日以内）
5. 再発防止策実装（1週間以内）
6. ポストモーテム作成・共有
```

### バックアップ・復旧

| データ種別 | バックアップ頻度 | 保持期間 | 復旧目標時間 |
|------------|------------------|----------|--------------|
| イベントデータ | 1日1回 | 30日間 | 4時間 |
| ユーザーデータ | 1日1回 | 30日間 | 2時間 |
| 位置情報ログ | リアルタイム | 7日間 | 1時間 |
| システム設定 | 変更時 | 90日間 | 30分 |

---

## 📱 ユーザビリティ要件

### デバイス対応

| デバイス | 対応要件 | 画面サイズ | ブラウザ |
|----------|----------|------------|----------|
| スマートフォン | 必須 | 320px ~ 480px | Chrome, Safari, Firefox |
| タブレット | 推奨 | 768px ~ 1024px | Chrome, Safari, Firefox |
| デスクトップ | オプション | 1024px ~ | Chrome, Safari, Firefox, Edge |

### アクセシビリティ

| 要件 | レベル | 対応内容 |
|------|--------|----------|
| WCAG準拠 | AA | カラーコントラスト、キーボード操作 |
| スクリーンリーダー | 対応 | alt属性、aria-label設定 |
| 音声入力 | 対応 | フォーム入力での音声認識 |
| 文字サイズ | 対応 | 200%まで拡大対応 |

### 操作性

| 機能 | 要件 | 測定指標 |
|------|------|----------|
| イベント検索 | 3タップ以内 | タップ数計測 |
| 参加登録 | 5タップ以内 | コンバージョン率 |
| 画面遷移 | 2秒以内 | ページ間移動時間 |
| エラー回復 | 1タップで再試行 | エラー率・回復率 |

---

## 🌍 互換性要件

### ブラウザ対応

| ブラウザ | 最低バージョン | 対応状況 | 備考 |
|----------|----------------|----------|------|
| Chrome | 90+ | フル対応 | メインターゲット |
| Safari | 14+ | フル対応 | iOS対応重要 |
| Firefox | 88+ | フル対応 | プライバシー重視ユーザー |
| Edge | 90+ | 基本対応 | Chromiumベース |

### API互換性

| 外部API | バージョン | 依存度 | 代替手段 |
|---------|------------|--------|----------|
| connpass API | v1 | 高 | 手動データ入力 |
| Google Maps API | v3 | 高 | OpenStreetMap |
| Geolocation API | HTML5 | 中 | 手動位置設定 |
| Supabase API | latest | 高 | 自前DB構築 |

---

## 📊 監視・運用要件

### 監視項目

#### システム監視
| 項目 | 監視間隔 | アラート条件 | 対応レベル |
|------|----------|--------------|------------|
| サーバー稼働状況 | 1分 | レスポンス無し | Critical |
| CPU使用率 | 5分 | 80%超過5分継続 | High |
| メモリ使用量 | 5分 | 90%超過 | High |
| ディスク使用量 | 1時間 | 85%超過 | Medium |
| データベース接続 | 1分 | 接続失敗 | Critical |

#### アプリケーション監視
| 項目 | 監視間隔 | アラート条件 | 対応レベル |
|------|----------|--------------|------------|
| API応答時間 | リアルタイム | 3秒超過 | High |
| エラー率 | 5分 | 5%超過 | Medium |
| 同時接続数 | 1分 | 制限値90%超過 | Medium |
| 外部API失敗率 | 15分 | 20%超過 | Medium |

### ログ管理

| ログ種別 | 保持期間 | 圧縮 | バックアップ |
|----------|----------|------|------------|
| アクセスログ | 90日 | gzip | 毎日 |
| エラーログ | 365日 | gzip | 毎日 |
| セキュリティログ | 365日 | 暗号化 | 毎日 |
| パフォーマンスログ | 30日 | gzip | 毎週 |

---

## 🔧 保守性要件

### コード品質

| 指標 | 目標値 | 測定ツール | 実施タイミング |
|------|---------|------------|----------------|
| テストカバレッジ | 80%以上 | Jest | 各プルリクエスト |
| 循環的複雑度 | 10以下 | ESLint | 各コミット |
| 技術的負債比率 | 5%以下 | SonarQube | 週次 |
| バンドルサイズ | 500KB以下 | Webpack Bundle Analyzer | リリース前 |

### ドキュメント

| 種別 | 更新頻度 | 担当者 | 品質基準 |
|------|----------|--------|----------|
| API仕様書 | 機能追加時 | 開発者 | OpenAPI準拠 |
| 運用手順書 | 月次見直し | DevOps | 実行可能性確認 |
| 障害対応手順 | 障害発生時 | SRE | シミュレーション実施 |
| ユーザー向け | 機能追加時 | PdM | ユーザビリティテスト |

---

## 🌱 拡張性要件

### 水平スケーリング

| コンポーネント | スケーリング方式 | 目標性能 | 実装方法 |
|----------------|------------------|----------|----------|
| Webサーバー | ロードバランサー | 10x | Vercel Edge Functions |
| データベース | Read Replica | 5x | Supabase読み取り専用DB |
| 画像配信 | CDN | 地域分散 | Cloudflare |
| API Gateway | 自動スケーリング | リクエスト量連動 | Supabase Functions |

### 垂直スケーリング

| リソース | 現在スペック | 拡張予定 | 拡張条件 |
|----------|--------------|----------|----------|
| CPU | 2コア | 4コア | CPU使用率70%超過継続 |
| メモリ | 4GB | 8GB | メモリ使用率80%超過 |
| ストレージ | 100GB | 500GB | 使用量80%到達 |
| 帯域幅 | 100Mbps | 1Gbps | 帯域使用率90%超過 |

---

## 📋 品質保証要件

### テスト要件

| テスト種別 | カバレッジ目標 | 実施タイミング | 自動化率 |
|------------|----------------|----------------|----------|
| 単体テスト | 80% | 各コミット | 100% |
| 統合テスト | 70% | PR作成時 | 100% |
| E2Eテスト | 主要シナリオ | リリース前 | 90% |
| パフォーマンステスト | 全API | 週次 | 100% |
| セキュリティテスト | 脆弱性チェック | 月次 | 80% |

### コード品質ゲート

| ステージ | 通過条件 | ブロック条件 |
|----------|----------|--------------|
| コミット | Lint成功 | 構文エラー・警告 |
| プルリクエスト | テスト成功、カバレッジ維持 | テスト失敗・カバレッジ低下 |
| マージ | レビュー承認 | 未レビュー・コンフリクト |
| リリース | 全テスト成功 | E2Eテスト失敗 |

---

## 🎯 成功指標・SLA

### サービスレベル指標

| 指標 | MVP目標 | 成長期目標 | 測定方法 |
|------|---------|------------|----------|
| 応答時間 | 90%が2秒以内 | 95%が1秒以内 | Real User Monitoring |
| 稼働率 | 99.0% | 99.5% | 監視システム |
| エラー率 | 2%以下 | 1%以下 | ログ分析 |
| ユーザー満足度 | 4.0/5.0 | 4.5/5.0 | アプリストア評価 |

### ビジネス指標連動

| 技術指標 | ビジネス影響 | 改善施策 |
|----------|--------------|----------|
| 検索速度向上 | イベント参加率向上 | インデックス最適化 |
| 位置精度向上 | 満足度向上 | GPS精度向上 |
| 障害時間短縮 | ユーザー離脱防止 | 監視体制強化 |
| API統合数増加 | イベント掲載数増加 | 外部連携拡大 |

---

## 📚 関連ドキュメント

- [機能詳細仕様](./features)
- [システムアーキテクチャ](../design/architecture)
- [セキュリティ設計](../design/security)
- [運用手順](../development/deployment)

---

## 🔄 更新履歴

| 日付 | 変更内容 | 更新者 |
|------|----------|--------|
| 2025/6/18 | 初版作成（MVP非機能要件） | Claude |

次回更新予定: 性能テスト結果反映時